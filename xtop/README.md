# XTOP - X Process Snapper Terminal UI

## Overview

XTOP (X Process Snapper) is an advanced terminal-based visualization and analysis tool for Linux system performance data collected by xcapture. It provides interactive exploration of system metrics through a powerful TUI (Terminal User Interface) built with Python and the Textual framework.

### Recent Updates (2025-08-19)

- **CSV Time Filtering**: Optimized DuckDB queries to read only relevant hourly CSV files based on time ranges
- **Histogram Query Fixes**: Resolved sample count multiplication in histogram queries
- **Pandas-Free Operations**: Eliminated pandas dependencies to avoid NA/null value issues
- **JSON Viewer**: Added syntax-highlighted JSON viewer for extra_info column
- **Row-Specific Peek Modals**: Peek modals now filter data by current row's GROUP BY values

## Architecture

### Core Purpose
XTOP analyzes CSV data files generated by xcapture (which uses eBPF for kernel-level monitoring) to provide insights into:
- Process/thread state sampling
- System call latencies  
- I/O request latencies
- Kernel and userspace stack traces
- System-wide performance patterns

### Key Design Principles

1. **Dynamic Query System**: The primary query type is "dynamic" which automatically:
   - Detects required data sources based on requested columns
   - Builds optimized SQL queries with appropriate JOINs
   - Handles computed columns and aggregations
   - Supports flexible GROUP BY operations

2. **Navigation-Driven Interface**: Every user action creates a navigation frame:
   - Full history with breadcrumb trail
   - Backspace to navigate backwards
   - Filters and groupings are tracked
   - State preservation across navigation

3. **Data Source Abstraction**: Multiple CSV sources are joined seamlessly:
   - `xcapture_samples_*.csv` - Core sampling data (base table)
   - `xcapture_syscend_*.csv` - System call completions
   - `xcapture_iorqend_*.csv` - I/O request completions  
   - `xcapture_kstacks_*.csv` - Kernel stack traces
   - `xcapture_ustacks_*.csv` - Userspace stack traces
   - `/proc/partitions` - Device name mappings

## Project Structure

```
xtop/
├── core/                      # Core business logic
│   ├── __init__.py           # Package exports
│   ├── data_source.py        # CSV data source management
│   ├── query_engine.py       # Dynamic SQL query builder
│   ├── query_builder.py      # Advanced query construction with histogram support
│   ├── csv_time_filter.py   # Time-based CSV file filtering with glob patterns
│   ├── navigation.py         # Navigation state management
│   ├── formatters.py         # Data formatting and display
│   ├── visualizers.py        # Unicode charts and visualizations
│   └── heatmap.py           # Latency heatmap generation
│
├── tui/                      # Terminal UI components
│   ├── __init__.py          
│   ├── cell_peek_modal.py   # Enhanced histogram modal with heatmaps
│   ├── stack_peek_modal.py  # Stack trace viewer modal
│   ├── json_viewer_modal.py # JSON viewer for extra_info column
│   └── error_modal.py       # Error display modal
│
├── tests/                    # Test suite
│   ├── test_runner.py       # Core test implementation
│   ├── README.md            # Test documentation
│   └── test_tui_basic.py    # TUI tests (optional)
│
├── sql/                      # SQL query templates (legacy)
│   ├── fragments/           # Reusable SQL fragments
│   └── *.sql               # Legacy query templates
│
├── run_tests.py             # Main test runner
├── xtop                     # Main TUI application
├── xtop-test.py             # CLI test interface
├── xtop-tui.py             # Symlink to xtop (for compatibility)
└── *.md                     # Documentation files
```

## Key Features

### Interactive TUI Controls

| Key | Action | Description |
|-----|--------|-------------|
| **g** | Group By | Change GROUP BY columns dynamically |
| **Enter** | Drill Down | Filter on selected cell value |
| **Space** | Filter Menu | Include/exclude filter options |
| **?** | Peek | View detailed information (histograms, stacks, heatmaps) |
| **Backspace** | Navigate Back | Return to previous view |
| **</>** | Reorder Columns | Move GROUP BY columns left/right |
| **l** | Latency Columns | Select aggregate columns to display |
| **r** | Refresh | Re-execute current query |

### Dynamic Query System

The dynamic query builder automatically:
1. Analyzes requested columns to determine required data sources
2. Generates appropriate JOINs only when needed
3. Handles computed columns (KSTACK_CURRENT_FUNC, FILENAMESUM, etc.)
4. Builds latency histograms when histogram columns are requested
5. Optimizes query performance by minimizing unnecessary JOINs

Example flow:
- User selects `KSTACK_HASH` in grouping
- System detects need for kstacks data source
- Automatically adds LEFT JOIN to kstacks CSV
- Handles stack symbol resolution

### Visualization Features

1. **Time Bars**: Visual representation of sample distribution
2. **Latency Histograms**: Unicode-based histogram visualization with drill-down capabilities
3. **Time-Series Heatmaps**: Interactive latency heatmaps with configurable time granularity
   - Toggle between HH (hourly), HH:MI (per-minute), and HH:MI:S10 (10-second) views
   - Dynamic width with horizontal scrolling for large time ranges
   - Automatic gap filling for missing time buckets
4. **Stack Traces**: Full stack trace viewing with symbol resolution
5. **Responsive Tables**: Auto-adjusting column widths with proper alignment

### Error Handling

- SQL errors display in modal popups instead of crashing
- Debug logging to file for troubleshooting
- Graceful degradation when data sources are missing

## Usage

### Basic Usage

```bash
# Set data directory
export XCAPTURE_DATADIR=/path/to/xcapture/out

# Interactive TUI
./xtop -d $XCAPTURE_DATADIR

# With time range
./xtop -d $XCAPTURE_DATADIR --from "2025-08-11T16:25:00" --to "2025-08-11T17:05:00"

# With initial grouping
./xtop -d $XCAPTURE_DATADIR -g "state,username,exe,syscall"

# With debug logging
./xtop -d $XCAPTURE_DATADIR --debuglog debug.log
```

### Command-Line Test Interface (Non-Interactive)

```bash
# Basic query test
./xtop-test.py -d $XCAPTURE_DATADIR --limit 10

# With GROUP BY and latency columns
./xtop-test.py -d $XCAPTURE_DATADIR -g "state,syscall" -l "sc.p95_us,sclat_histogram"

# With WHERE clause filtering
./xtop-test.py -d $XCAPTURE_DATADIR -w "state IN ('SLEEP', 'RUN')" --limit 5
```

## Implementation Details

### Column Name Handling
- Column names are case-insensitive internally
- Display names are formatted for readability (e.g., `avg_threads` → `avg_thr`)
- Computed columns are generated on-the-fly based on context

### Performance Optimizations
- Queries use DuckDB for fast analytical processing
- Time-based CSV filtering reduces file I/O by reading only relevant hourly files
- Data is cached in memory during session
- Only required JOINs are performed
- Histogram data is pre-aggregated with sample_counts CTE to prevent multiplication
- Glob patterns optimize file selection (e.g., `xcapture_samples_2025-08-11.1[6-7].csv`)

### Stack Trace Integration
- MD5 hashes link samples to deduplicated stack traces
- `KSTACK_CURRENT_FUNC` extracts top function from stack
- Full stack viewing available via peek modal

## Testing

### Streamlined Test Infrastructure

XTOP features a modern, streamlined test suite that runs all tests in ~13 seconds:

```bash
# Set data directory
export XCAPTURE_DATADIR=/path/to/xcapture/out

# Run all tests (recommended)
./run_tests.py

# Run specific test suite
./run_tests.py basic        # Core functionality (5 tests)
./run_tests.py latency     # Latency analysis (4 tests)
./run_tests.py stack       # Stack traces (3 tests)
./run_tests.py advanced    # Complex queries (4 tests)

# Options
./run_tests.py -v          # Verbose output
./run_tests.py --save      # Save results to JSON
```

The test suite includes:
- **16 comprehensive tests** covering all functionality
- **Color-coded output** with real-time progress
- **JSON export** for CI/CD integration
- **Single entry point** for all testing

For detailed testing information, see [TESTING.md](TESTING.md).

## Technical Stack

- **Python 3.8+**: Core language
- **Textual**: Modern TUI framework
- **DuckDB**: In-memory analytical database
- **CSV**: Data storage format from xcapture

## Future Enhancements

- [ ] Flame graph generation from stack data
- [ ] Export functionality for processed data
- [ ] Real-time monitoring mode
- [ ] Custom query templates
- [ ] Performance profiling integration

## Related Components

- **xcapture**: eBPF-based data collection tool
- **0xtools**: Parent project for Linux performance analysis
- **libbpf**: eBPF library used by xcapture

## License

Part of the 0xtools project. See main project for licensing details.