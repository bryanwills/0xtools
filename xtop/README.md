# XTOP - X Process Snapper Terminal UI

## Overview

XTOP (X Process Snapper) is an advanced terminal-based visualization and analysis tool for Linux system performance data collected by xcapture. It provides interactive exploration of system metrics through a powerful TUI (Terminal User Interface) built with Python and the Textual framework.

### Recent Updates (2025-08-19)

- **CSV Time Filtering**: Optimized DuckDB queries to read only relevant hourly CSV files based on time ranges
- **Histogram Query Fixes**: Resolved sample count multiplication in histogram queries
- **Pandas-Free Operations**: Eliminated pandas dependencies to avoid NA/null value issues
- **JSON Viewer**: Added syntax-highlighted JSON viewer for extra_info column
- **Row-Specific Peek Modals**: Peek modals now filter data by current row's GROUP BY values

## Architecture

### Core Purpose
XTOP analyzes CSV data files generated by xcapture (which uses eBPF for kernel-level monitoring) to provide insights into:
- Process/thread state sampling
- System call latencies  
- I/O request latencies
- Kernel and userspace stack traces
- System-wide performance patterns

### Key Design Principles

1. **Dynamic Query System**: The primary query type is "dynamic" which automatically:
   - Detects required data sources based on requested columns
   - Builds optimized SQL queries with appropriate JOINs
   - Handles computed columns and aggregations
   - Supports flexible GROUP BY operations

2. **Navigation-Driven Interface**: Every user action creates a navigation frame:
   - Full history with breadcrumb trail
   - Backspace to navigate backwards
   - Filters and groupings are tracked
   - State preservation across navigation

3. **Data Source Abstraction**: Multiple CSV sources are joined seamlessly:
   - `xcapture_samples_*.csv` - Core sampling data (base table)
   - `xcapture_syscend_*.csv` - System call completions
   - `xcapture_iorqend_*.csv` - I/O request completions  
   - `xcapture_kstacks_*.csv` - Kernel stack traces
   - `xcapture_ustacks_*.csv` - Userspace stack traces
   - `/proc/partitions` - Device name mappings

## Project Structure

```
xtop/
├── core/                      # Core business logic
│   ├── __init__.py           # Package exports
│   ├── data_source.py        # CSV data source management
│   ├── query_engine.py       # Dynamic SQL query builder
│   ├── query_builder.py      # Advanced query construction with histogram support
│   ├── csv_time_filter.py   # Time-based CSV file filtering with glob patterns
│   ├── navigation.py         # Navigation state management
│   ├── formatters.py         # Data formatting and display
│   ├── visualizers.py        # Unicode charts and visualizations
│   └── heatmap.py           # Latency heatmap generation
│
├── tui/                      # Terminal UI components
│   ├── __init__.py          
│   ├── cell_peek_modal.py   # Enhanced histogram modal with heatmaps
│   ├── stack_peek_modal.py  # Stack trace viewer modal
│   ├── json_viewer_modal.py # JSON viewer for extra_info column
│   └── error_modal.py       # Error display modal
│
├── tests/                    # Test suite
│   ├── test_tui_basic.py    # Basic TUI tests using Textual's Pilot
│   ├── test_tui_mapping.py  # CLI parameter mapping tests
│   ├── run_tests.sh         # Run basic test suite
│   ├── run_extended_tests.sh# Run extended test suite
│   ├── run_tui_tests.sh     # Run TUI headless tests
│   └── run_before_after_tests.py # Comprehensive testing
│
├── sql/                      # SQL query templates (legacy)
│   ├── fragments/           # Reusable SQL fragments
│   └── *.sql               # Legacy query templates
│
├── xtop-tui.py              # Main TUI application
├── xtop-test.py             # CLI test interface
├── xtop.py                  # CLI tool (non-interactive)
└── *.md                     # Documentation files
```

## Key Features

### Interactive TUI Controls

| Key | Action | Description |
|-----|--------|-------------|
| **g** | Group By | Change GROUP BY columns dynamically |
| **Enter** | Drill Down | Filter on selected cell value |
| **Space** | Filter Menu | Include/exclude filter options |
| **?** | Peek | View detailed information (histograms, stacks, heatmaps) |
| **Backspace** | Navigate Back | Return to previous view |
| **</>** | Reorder Columns | Move GROUP BY columns left/right |
| **l** | Latency Columns | Select aggregate columns to display |
| **r** | Refresh | Re-execute current query |

### Dynamic Query System

The dynamic query builder automatically:
1. Analyzes requested columns to determine required data sources
2. Generates appropriate JOINs only when needed
3. Handles computed columns (KSTACK_CURRENT_FUNC, FILENAMESUM, etc.)
4. Builds latency histograms when histogram columns are requested
5. Optimizes query performance by minimizing unnecessary JOINs

Example flow:
- User selects `KSTACK_HASH` in grouping
- System detects need for kstacks data source
- Automatically adds LEFT JOIN to kstacks CSV
- Handles stack symbol resolution

### Visualization Features

1. **Time Bars**: Visual representation of sample distribution
2. **Latency Histograms**: Unicode-based histogram visualization with drill-down capabilities
3. **Time-Series Heatmaps**: Interactive latency heatmaps with configurable time granularity
   - Toggle between HH (hourly), HH:MI (per-minute), and HH:MI:S10 (10-second) views
   - Dynamic width with horizontal scrolling for large time ranges
   - Automatic gap filling for missing time buckets
4. **Stack Traces**: Full stack trace viewing with symbol resolution
5. **Responsive Tables**: Auto-adjusting column widths with proper alignment

### Error Handling

- SQL errors display in modal popups instead of crashing
- Debug logging to file for troubleshooting
- Graceful degradation when data sources are missing

## Usage

### Basic Usage

```bash
# Interactive TUI with dynamic query
./xtop-tui.py -d out -q dynamic

# With time range
./xtop-tui.py -d out -q dynamic --from "2025-08-03T03:40:00" --to "2025-08-03T04:07:00"

# With initial grouping
./xtop-tui.py -d out -q dynamic -g "state,user,exe,syscall"

# With debug logging
./xtop-tui.py -d out -q dynamic --debuglog debug.log
```

### Command-Line Interface (Non-Interactive)

```bash
# Basic top-like view
./xtop.py -d out

# System call latency analysis
./xtop.py -d out -q sclat

# I/O latency histogram
./xtop.py -d out -q iolathist
```

## Implementation Details

### Column Name Handling
- Column names are case-insensitive internally
- Display names are formatted for readability (e.g., `avg_threads` → `avg_thr`)
- Computed columns are generated on-the-fly based on context

### Performance Optimizations
- Queries use DuckDB for fast analytical processing
- Time-based CSV filtering reduces file I/O by reading only relevant hourly files
- Data is cached in memory during session
- Only required JOINs are performed
- Histogram data is pre-aggregated with sample_counts CTE to prevent multiplication
- Glob patterns optimize file selection (e.g., `xcapture_samples_2025-08-11.1[6-7].csv`)

### Stack Trace Integration
- MD5 hashes link samples to deduplicated stack traces
- `KSTACK_CURRENT_FUNC` extracts top function from stack
- Full stack viewing available via peek modal

## Testing

### Standardized Test Runner

XTOP includes a comprehensive test suite with a single-command test runner:

```bash
# Run ALL test suites (recommended)
./run_tests.sh

# Run specific test suites
./run_tests.sh basic        # Basic functionality tests
./run_tests.sh extended     # Extended feature tests
./run_tests.sh tui         # TUI headless tests
./run_tests.sh before-after # Regression tests
./run_tests.sh quick       # Quick verification test

# Verbose output
./run_tests.sh -v          # Show detailed test output
```

The test suite includes:
- **Basic Tests**: 12 core functionality tests
- **Extended Tests**: 13 advanced feature tests
- **TUI Tests**: Headless UI interaction tests using Textual's Pilot
- **Before/After Tests**: 22 comprehensive regression tests

All tests complete in approximately 75 seconds and provide color-coded output with a summary report.

For detailed testing information, see [TESTING_GUIDE.md](TESTING_GUIDE.md).

## Technical Stack

- **Python 3.8+**: Core language
- **Textual**: Modern TUI framework
- **DuckDB**: In-memory analytical database
- **CSV**: Data storage format from xcapture

## Future Enhancements

- [ ] Flame graph generation from stack data
- [ ] Export functionality for processed data
- [ ] Real-time monitoring mode
- [ ] Custom query templates
- [ ] Performance profiling integration

## Related Components

- **xcapture**: eBPF-based data collection tool
- **0xtools**: Parent project for Linux performance analysis
- **libbpf**: eBPF library used by xcapture

## License

Part of the 0xtools project. See main project for licensing details.